{
  "resourceType": "Library",
  "meta": {
    "profile": [
      "http://hl7.eu/fhir/ig/gravitate-health/StructureDefinition/lens"
    ]
  },
  "extension": [
    {
      "url": "http://hl7.eu/fhir/ig/gravitate-health/StructureDefinition/lee-version",
      "valueString": "dev"
    }
  ],
  "url": "https://gravitate-health.lst.tfo.upm.es/ips/api/fhir/Library/592",
  "identifier": [
    {
      "system": "http://gravitate-health.lst.tfo.upm.es",
      "value": "preadmission-lens"
    }
  ],
  "version": "0.0.1",
  "name": "preadmission Lens",
  "_name": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Lente de Interacci\u00f3n"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Lente de Intera\u00e7\u00e3o"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Interaktionslinse"
          }
        ]
      }
    ]
  },
  "date": "2024-06-12T13:40:03.690Z",
  "title": "preadmission Lens",
  "_title": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Lente de Interacci\u00f3n"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Lente de Intera\u00e7\u00e3o"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Interaktionslinse"
          }
        ]
      }
    ]
  },
  "status": "draft",
  "experimental": true,
  "type": {
    "coding": [
      {
        "code": "logical-library"
      }
    ]
  },
  "publisher": "Gravitate Health Project - UPM Team",
  "contact": [
    {
      "name": "Gravitate Health",
      "telecom": [
        {
          "system": "url",
          "value": "https://www.gravitatehealth.eu/"
        }
      ]
    }
  ],
  "description": "A lens that highlight any information related to interactions between other mediciones or ePIs",
  "_description": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Una lente que resalta cualquier informaci\u00f3n relacionada con interacciones entre otros medicamentos o ePIs."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Uma lente que destaca qualquer informa\u00e7\u00e3o relacionada com intera\u00e7\u00f5es entre outros medicamentos ou ePIs."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "En linse, der fremh\u00e6ver al information relateret til interaktioner mellem andre l\u00e6gemidler eller ePI'er."
          }
        ]
      }
    ]
  },
  "jurisdiction": [
    {
      "coding": [
        {
          "code": "EU",
          "system": "urn:iso:std:iso:3166"
        }
      ]
    }
  ],
  "purpose": "Clarify the important things related to interactions between other ePIs in the ePI provided",
  "_purpose": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Aclarar los aspectos importantes relacionados con interacciones entre otros ePIs en el ePI proporcionado."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Esclarecer os pontos importantes relacionados com intera\u00e7\u00f5es entre outros ePIs no ePI fornecido."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Klarg\u00f8r de vigtige ting vedr\u00f8rende interaktioner mellem andre ePI'er i den angivne ePI."
          }
        ]
      }
    ]
  },
  "usage": "This lens requires a preprocessed ePI, and an IPS to work. You can import this lens directly to your FHIR Server which suports Library Resource type.",
  "_usage": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Esta lente requiere una ePI preprocesada y un IPS para funcionar. Puedes importar esta lente directamente en tu servidor FHIR que soporte el tipo de recurso Library."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Esta lente requer uma ePI pr\u00e9-processada e um IPS para funcionar. Podes importar esta lente diretamente para o teu servidor FHIR que suporte o tipo de recurso Library."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Denne linse kr\u00e6ver en forbehandlet ePI og en IPS for at fungere. Du kan importere denne linse direkte til din FHIR-server, som underst\u00f8tter ressource-typen Library."
          }
        ]
      }
    ]
  },
  "copyright": "\u00a9 2024 Gravitate Health",
  "parameter": [
    {
      "use": "in",
      "documentation": "parameter if it exists",
      "type": "CodeableConcept"
    }
  ],
  "content": [
    {
      "contentType": "application/javascript",
      "data": ""
    }
  ],
  "data": "bGV0IHB2RGF0YSA9IHB2OwpsZXQgaHRtbERhdGEgPSBodG1sOwoKbGV0IGVwaURhdGEgPSBlcGk7CmxldCBpcHNEYXRhID0gaXBzOwoKbGV0IGdldFNwZWNpZmljYXRpb24gPSAoKSA9PiB7CiAgICByZXR1cm4gIjEuMC4wLXByZWFkbWlzc2lvbi1iYW5uZXIiOwp9OwovL2RvY3VtZW50LCBodG1sRGF0YSwgYmFubmVySFRNTAovLwpjb25zdCBpbnNlcnRRdWVzdGlvbm5haXJlTGluayA9IChsaXN0T2ZDYXRlZ29yaWVzLCBsYW5ndWFnZSwgZG9jdW1lbnQsIHJlc3BvbnNlKSA9PiB7CgogICAgaWYgKGxhbmd1YWdlPy5zdGFydHNXaXRoKCJwdCIpKSB7CiAgICAgICAgbGlua0hUTUwgPSAiaHR0cHM6Ly9leGFtcGxlLm9yZy9xdWVzdGlvbm5haXJlL2hpZ2gtcmlzayI7CgogICAgfSBlbHNlIGlmIChsYW5ndWFnZT8uc3RhcnRzV2l0aCgiZW4iKSkgewogICAgICAgIGxpbmtIVE1MID0gImh0dHBzOi8vZXhhbXBsZS5vcmcvcXVlc3Rpb25uYWlyZS9oaWdoLXJpc2siOwoKICAgIH0gZWxzZSBpZiAobGFuZ3VhZ2U/LnN0YXJ0c1dpdGgoImVzIikpIHsKICAgICAgICBsaW5rSFRNTCA9ICJodHRwczovL2V4YW1wbGUub3JnL3F1ZXN0aW9ubmFpcmUvaGlnaC1yaXNrIjsKCiAgICB9IGVsc2UgaWYgKGxhbmd1YWdlPy5zdGFydHNXaXRoKCJkYSIpKSB7CiAgICAgICAgbGlua0hUTUwgPSAiaHR0cHM6Ly9leGFtcGxlLm9yZy9xdWVzdGlvbm5haXJlL2hpZ2gtcmlzayI7CgogICAgfSBlbHNlIHsKICAgICAgICBsaW5rSFRNTCA9ICJodHRwczovL2V4YW1wbGUub3JnL3F1ZXN0aW9ubmFpcmUvaGlnaC1yaXNrIjsKCiAgICB9CiAgICBsZXQgc2hvdWxkQXBwZW5kID0gZmFsc2U7IC8vZm9yIGZ1dHVyZSB1c2FnZQogICAgbGV0IGZvdW5kQ2F0ZWdvcnkgPSBmYWxzZTsKICAgIGNvbnNvbGUubG9nKGxpc3RPZkNhdGVnb3JpZXMpCiAgICBjb25zb2xlLmxvZyhsaXN0T2ZDYXRlZ29yaWVzLmxlbmd0aCkKICAgIGxpc3RPZkNhdGVnb3JpZXMuZm9yRWFjaCgoY2xhc3NOYW1lKSA9PiB7CiAgICAgICAgaWYgKAogICAgICAgICAgICByZXNwb25zZS5pbmNsdWRlcyhgY2xhc3M9IiR7Y2xhc3NOYW1lfWApIHx8CiAgICAgICAgICAgIHJlc3BvbnNlLmluY2x1ZGVzKGBjbGFzcz0nJHtjbGFzc05hbWV9YCkKICAgICAgICApIHsKICAgICAgICAgICAgY29uc3QgZWxlbWVudHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZWxlbWVudHNbaV07CiAgICAgICAgICAgICAgICBjb25zdCBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgICAgICAgICAgICAgbGluay5zZXRBdHRyaWJ1dGUoImhyZWYiLCBsaW5rSFRNTCk7CiAgICAgICAgICAgICAgICBsaW5rLnNldEF0dHJpYnV0ZSgidGFyZ2V0IiwgIl9ibGFuayIpOwogICAgICAgICAgICAgICAgbGluay5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgInByZWFkbWlzc2lvbi1sZW5zIik7CgogICAgICAgICAgICAgICAgaWYgKHNob3VsZEFwcGVuZCkgewogICAgICAgICAgICAgICAgICAgIC8vIEFwcGVuZCB0aGUgbGluayBhcyBhIG5ldyBlbGVtZW50IGluc2lkZSB0aGUgZXhpc3RpbmcgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIGxpbmsuaW5uZXJIVE1MID0gIvCfk50gRmlsbCBvdXQgc2FmZXR5IHF1ZXN0aW9ubmFpcmUiOwogICAgICAgICAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKGxpbmspOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBXcmFwIHRoZSBleGlzdGluZyBjb250ZW50cyBvZiB0aGUgZWxlbWVudCBpbiB0aGUgbGluawogICAgICAgICAgICAgICAgICAgIGxpbmsuaW5uZXJIVE1MID0gZWwuaW5uZXJIVE1MOwogICAgICAgICAgICAgICAgICAgIGVsLmlubmVySFRNTCA9ICIiOwogICAgICAgICAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKGxpbmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvdW5kQ2F0ZWdvcnkgPSB0cnVlOwogICAgICAgIH0KICAgIH0pOwoKICAgIGNvbnNvbGUubG9nIChmb3VuZENhdGVnb3J5KTsKICAgIC8vIE5vIG1hdGNoaW5nIGNhdGVnb3J5IHRhZ3Mg4oaSIGluamVjdCBiYW5uZXIgYXQgdG9wCiAgICBpZiAoIWZvdW5kQ2F0ZWdvcnkpIHsKCiAgICAgICAgY29uc3QgYmFubmVyRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CgogICAgICAgIGlmIChsYW5ndWFnZT8uc3RhcnRzV2l0aCgicHQiKSkgewogICAgICAgICAgICBiYW5uZXJEaXYuaW5uZXJIVE1MID0gYAo8ZGl2IGNsYXNzPSJhbGVydC1iYW5uZXIgZW1lcmdlbmN5LWNhbGwgcHJlYWRtaXNzaW9uLWxlbnMiIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiNmZmYzY2Q7cGFkZGluZzoxZW07Ym9yZGVyOjFweCBzb2xpZCAjZjVjMmM3O21hcmdpbi1ib3R0b206MWVtO2JvcmRlci1yYWRpdXM6NXB4O2ZvbnQtZmFtaWx5OnNhbnMtc2VyaWY7Ij4KICA8c3Ryb25nPuKaoO+4jyBXYXJuaW5nIGZvciBwYXRpZW50cyB3aXRoIGhlYXJ0IGZhaWx1cmUgdGFraW5nIEZ1cm9zZW1pZGU8L3N0cm9uZz48YnI+PGJyPgoKICBGdXJvc2VtaWRlIGhlbHBzIHJlZHVjZSBmbHVpZCBidWlsZHVwLCBidXQgaW4gc29tZSBjYXNlcyBpdCBtYXkgY2F1c2Ugc2VyaW91cyBzaWRlIGVmZmVjdHMgdGhhdCByZXF1aXJlIGltbWVkaWF0ZSBtZWRpY2FsIGF0dGVudGlvbi4gUGxlYXNlIHN0b3AgYW5kIHNlZWsgZW1lcmdlbmN5IGNhcmUgaWYgeW91IGV4cGVyaWVuY2UgYW55IG9mIHRoZSBmb2xsb3dpbmc6CgogIDx1bCBzdHlsZT0ibWFyZ2luLXRvcDogMWVtOyBtYXJnaW4tYm90dG9tOiAxZW07Ij4KICAgIDxsaT48c3Ryb25nPlNldmVyZSBkaXp6aW5lc3Mgb3IgZmFpbnRpbmc8L3N0cm9uZz4g4oCTIG1heSBpbmRpY2F0ZSBsb3cgYmxvb2QgcHJlc3N1cmUgb3IgZmx1aWQgbG9zczwvbGk+CiAgICA8bGk+PHN0cm9uZz5NdXNjbGUgY3JhbXBzIG9yIHdlYWtuZXNzPC9zdHJvbmc+IOKAkyBjb3VsZCBiZSBhIHNpZ24gb2YgbG93IHBvdGFzc2l1bTwvbGk+CiAgICA8bGk+PHN0cm9uZz5JcnJlZ3VsYXIgb3IgZmFzdCBoZWFydGJlYXQ8L3N0cm9uZz4g4oCTIG1heSBpbmRpY2F0ZSBhIHNlcmlvdXMgZWxlY3Ryb2x5dGUgaW1iYWxhbmNlPC9saT4KICAgIDxsaT48c3Ryb25nPlN1ZGRlbiBjaGVzdCBwYWluPC9zdHJvbmc+IOKAkyBwb3NzaWJsZSBjYXJkaWFjIGNvbXBsaWNhdGlvbjwvbGk+CiAgICA8bGk+PHN0cm9uZz5Db25mdXNpb24gb3IgZXh0cmVtZSBmYXRpZ3VlPC9zdHJvbmc+IOKAkyBtYXkgc2lnbmFsIGxvdyBzb2RpdW0gb3IgZGVoeWRyYXRpb248L2xpPgogICAgPGxpPjxzdHJvbmc+SGVhcmluZyBsb3NzIG9yIHJpbmdpbmcgaW4gdGhlIGVhcnM8L3N0cm9uZz4g4oCTIHJhcmUgYnV0IHNlcmlvdXMgYXQgaGlnaCBkb3NlczwvbGk+CiAgICA8bGk+PHN0cm9uZz5Ucm91YmxlIGJyZWF0aGluZyBvciBzd2VsbGluZyBvZiB0aGUgZmFjZS9saXBzPC9zdHJvbmc+IOKAkyBwb3NzaWJsZSBhbGxlcmdpYyByZWFjdGlvbjwvbGk+CiAgPC91bD4KCiAgPGJ1dHRvbiBvbmNsaWNrPSJjYWxsRW1lcmdlbmN5U3VwcG9ydCgpIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojZDk1MzRmO2NvbG9yOndoaXRlO3BhZGRpbmc6MC43NWVtIDEuNWVtO2JvcmRlcjpub25lO2JvcmRlci1yYWRpdXM6NXB4O2ZvbnQtd2VpZ2h0OmJvbGQ7Y3Vyc29yOnBvaW50ZXI7Ij4KICAgIPCfmqggQ29udGFjdCBFbWVyZ2VuY3kgU3VwcG9ydAogIDwvYnV0dG9uPgo8L2Rpdj4KICAgICAgYDsKCiAgICAgICAgfSBlbHNlIGlmIChsYW5ndWFnZT8uc3RhcnRzV2l0aCgiZW4iKSkgewogICAgICAgICAgICBiYW5uZXJEaXYuaW5uZXJIVE1MID0gYAo8ZGl2IGNsYXNzPSJhbGVydC1iYW5uZXIgZW1lcmdlbmN5LWNhbGwgcHJlYWRtaXNzaW9uLWxlbnMiIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiNmZmYzY2Q7cGFkZGluZzoxZW07Ym9yZGVyOjFweCBzb2xpZCAjZjVjMmM3O21hcmdpbi1ib3R0b206MWVtO2JvcmRlci1yYWRpdXM6NXB4O2ZvbnQtZmFtaWx5OnNhbnMtc2VyaWY7Ij4KICA8c3Ryb25nPuKaoO+4jyBXYXJuaW5nIGZvciBwYXRpZW50cyB3aXRoIGhlYXJ0IGZhaWx1cmUgdGFraW5nIEZ1cm9zZW1pZGU8L3N0cm9uZz48YnI+PGJyPgoKICBGdXJvc2VtaWRlIGhlbHBzIHJlZHVjZSBmbHVpZCBidWlsZHVwLCBidXQgaW4gc29tZSBjYXNlcyBpdCBtYXkgY2F1c2Ugc2VyaW91cyBzaWRlIGVmZmVjdHMgdGhhdCByZXF1aXJlIGltbWVkaWF0ZSBtZWRpY2FsIGF0dGVudGlvbi4gUGxlYXNlIHN0b3AgYW5kIHNlZWsgZW1lcmdlbmN5IGNhcmUgaWYgeW91IGV4cGVyaWVuY2UgYW55IG9mIHRoZSBmb2xsb3dpbmc6CgogIDx1bCBzdHlsZT0ibWFyZ2luLXRvcDogMWVtOyBtYXJnaW4tYm90dG9tOiAxZW07Ij4KICAgIDxsaT48c3Ryb25nPlNldmVyZSBkaXp6aW5lc3Mgb3IgZmFpbnRpbmc8L3N0cm9uZz4g4oCTIG1heSBpbmRpY2F0ZSBsb3cgYmxvb2QgcHJlc3N1cmUgb3IgZmx1aWQgbG9zczwvbGk+CiAgICA8bGk+PHN0cm9uZz5NdXNjbGUgY3JhbXBzIG9yIHdlYWtuZXNzPC9zdHJvbmc+IOKAkyBjb3VsZCBiZSBhIHNpZ24gb2YgbG93IHBvdGFzc2l1bTwvbGk+CiAgICA8bGk+PHN0cm9uZz5JcnJlZ3VsYXIgb3IgZmFzdCBoZWFydGJlYXQ8L3N0cm9uZz4g4oCTIG1heSBpbmRpY2F0ZSBhIHNlcmlvdXMgZWxlY3Ryb2x5dGUgaW1iYWxhbmNlPC9saT4KICAgIDxsaT48c3Ryb25nPlN1ZGRlbiBjaGVzdCBwYWluPC9zdHJvbmc+IOKAkyBwb3NzaWJsZSBjYXJkaWFjIGNvbXBsaWNhdGlvbjwvbGk+CiAgICA8bGk+PHN0cm9uZz5Db25mdXNpb24gb3IgZXh0cmVtZSBmYXRpZ3VlPC9zdHJvbmc+IOKAkyBtYXkgc2lnbmFsIGxvdyBzb2RpdW0gb3IgZGVoeWRyYXRpb248L2xpPgogICAgPGxpPjxzdHJvbmc+SGVhcmluZyBsb3NzIG9yIHJpbmdpbmcgaW4gdGhlIGVhcnM8L3N0cm9uZz4g4oCTIHJhcmUgYnV0IHNlcmlvdXMgYXQgaGlnaCBkb3NlczwvbGk+CiAgICA8bGk+PHN0cm9uZz5Ucm91YmxlIGJyZWF0aGluZyBvciBzd2VsbGluZyBvZiB0aGUgZmFjZS9saXBzPC9zdHJvbmc+IOKAkyBwb3NzaWJsZSBhbGxlcmdpYyByZWFjdGlvbjwvbGk+CiAgPC91bD4KCiAgPGJ1dHRvbiBvbmNsaWNrPSJjYWxsRW1lcmdlbmN5U3VwcG9ydCgpIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojZDk1MzRmO2NvbG9yOndoaXRlO3BhZGRpbmc6MC43NWVtIDEuNWVtO2JvcmRlcjpub25lO2JvcmRlci1yYWRpdXM6NXB4O2ZvbnQtd2VpZ2h0OmJvbGQ7Y3Vyc29yOnBvaW50ZXI7Ij4KICAgIPCfmqggQ29udGFjdCBFbWVyZ2VuY3kgU3VwcG9ydAogIDwvYnV0dG9uPgo8L2Rpdj4KICAgICAgYDsKCiAgICAgICAgfSBlbHNlIGlmIChsYW5ndWFnZT8uc3RhcnRzV2l0aCgiZXMiKSkgewogICAgICAgICAgICBiYW5uZXJEaXYuaW5uZXJIVE1MID0gYAo8ZGl2IGNsYXNzPSJhbGVydC1iYW5uZXIgZW1lcmdlbmN5LWNhbGwgcHJlYWRtaXNzaW9uLWxlbnMiIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiNmZmYzY2Q7cGFkZGluZzoxZW07Ym9yZGVyOjFweCBzb2xpZCAjZjVjMmM3O21hcmdpbi1ib3R0b206MWVtO2JvcmRlci1yYWRpdXM6NXB4O2ZvbnQtZmFtaWx5OnNhbnMtc2VyaWY7Ij4KICA8c3Ryb25nPuKaoO+4jyBXYXJuaW5nIGZvciBwYXRpZW50cyB3aXRoIGhlYXJ0IGZhaWx1cmUgdGFraW5nIEZ1cm9zZW1pZGU8L3N0cm9uZz48YnI+PGJyPgoKICBGdXJvc2VtaWRlIGhlbHBzIHJlZHVjZSBmbHVpZCBidWlsZHVwLCBidXQgaW4gc29tZSBjYXNlcyBpdCBtYXkgY2F1c2Ugc2VyaW91cyBzaWRlIGVmZmVjdHMgdGhhdCByZXF1aXJlIGltbWVkaWF0ZSBtZWRpY2FsIGF0dGVudGlvbi4gUGxlYXNlIHN0b3AgYW5kIHNlZWsgZW1lcmdlbmN5IGNhcmUgaWYgeW91IGV4cGVyaWVuY2UgYW55IG9mIHRoZSBmb2xsb3dpbmc6CgogIDx1bCBzdHlsZT0ibWFyZ2luLXRvcDogMWVtOyBtYXJnaW4tYm90dG9tOiAxZW07Ij4KICAgIDxsaT48c3Ryb25nPlNldmVyZSBkaXp6aW5lc3Mgb3IgZmFpbnRpbmc8L3N0cm9uZz4g4oCTIG1heSBpbmRpY2F0ZSBsb3cgYmxvb2QgcHJlc3N1cmUgb3IgZmx1aWQgbG9zczwvbGk+CiAgICA8bGk+PHN0cm9uZz5NdXNjbGUgY3JhbXBzIG9yIHdlYWtuZXNzPC9zdHJvbmc+IOKAkyBjb3VsZCBiZSBhIHNpZ24gb2YgbG93IHBvdGFzc2l1bTwvbGk+CiAgICA8bGk+PHN0cm9uZz5JcnJlZ3VsYXIgb3IgZmFzdCBoZWFydGJlYXQ8L3N0cm9uZz4g4oCTIG1heSBpbmRpY2F0ZSBhIHNlcmlvdXMgZWxlY3Ryb2x5dGUgaW1iYWxhbmNlPC9saT4KICAgIDxsaT48c3Ryb25nPlN1ZGRlbiBjaGVzdCBwYWluPC9zdHJvbmc+IOKAkyBwb3NzaWJsZSBjYXJkaWFjIGNvbXBsaWNhdGlvbjwvbGk+CiAgICA8bGk+PHN0cm9uZz5Db25mdXNpb24gb3IgZXh0cmVtZSBmYXRpZ3VlPC9zdHJvbmc+IOKAkyBtYXkgc2lnbmFsIGxvdyBzb2RpdW0gb3IgZGVoeWRyYXRpb248L2xpPgogICAgPGxpPjxzdHJvbmc+SGVhcmluZyBsb3NzIG9yIHJpbmdpbmcgaW4gdGhlIGVhcnM8L3N0cm9uZz4g4oCTIHJhcmUgYnV0IHNlcmlvdXMgYXQgaGlnaCBkb3NlczwvbGk+CiAgICA8bGk+PHN0cm9uZz5Ucm91YmxlIGJyZWF0aGluZyBvciBzd2VsbGluZyBvZiB0aGUgZmFjZS9saXBzPC9zdHJvbmc+IOKAkyBwb3NzaWJsZSBhbGxlcmdpYyByZWFjdGlvbjwvbGk+CiAgPC91bD4KCiAgPGJ1dHRvbiBvbmNsaWNrPSJjYWxsRW1lcmdlbmN5U3VwcG9ydCgpIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojZDk1MzRmO2NvbG9yOndoaXRlO3BhZGRpbmc6MC43NWVtIDEuNWVtO2JvcmRlcjpub25lO2JvcmRlci1yYWRpdXM6NXB4O2ZvbnQtd2VpZ2h0OmJvbGQ7Y3Vyc29yOnBvaW50ZXI7Ij4KICAgIPCfmqggQ29udGFjdCBFbWVyZ2VuY3kgU3VwcG9ydAogIDwvYnV0dG9uPgo8L2Rpdj4KICAgICAgYDsKICAgICAgICB9IGVsc2UgaWYgKGxhbmd1YWdlPy5zdGFydHNXaXRoKCJkYSIpKSB7CiAgICAgICAgICAgIGJhbm5lckRpdi5pbm5lckhUTUwgPSBgCjxkaXYgY2xhc3M9ImFsZXJ0LWJhbm5lciBlbWVyZ2VuY3ktY2FsbCBwcmVhZG1pc3Npb24tbGVucyIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6I2ZmZjNjZDtwYWRkaW5nOjFlbTtib3JkZXI6MXB4IHNvbGlkICNmNWMyYzc7bWFyZ2luLWJvdHRvbToxZW07Ym9yZGVyLXJhZGl1czo1cHg7Zm9udC1mYW1pbHk6c2Fucy1zZXJpZjsiPgogIDxzdHJvbmc+4pqg77iPIFdhcm5pbmcgZm9yIHBhdGllbnRzIHdpdGggaGVhcnQgZmFpbHVyZSB0YWtpbmcgRnVyb3NlbWlkZTwvc3Ryb25nPjxicj48YnI+CgogIEZ1cm9zZW1pZGUgaGVscHMgcmVkdWNlIGZsdWlkIGJ1aWxkdXAsIGJ1dCBpbiBzb21lIGNhc2VzIGl0IG1heSBjYXVzZSBzZXJpb3VzIHNpZGUgZWZmZWN0cyB0aGF0IHJlcXVpcmUgaW1tZWRpYXRlIG1lZGljYWwgYXR0ZW50aW9uLiBQbGVhc2Ugc3RvcCBhbmQgc2VlayBlbWVyZ2VuY3kgY2FyZSBpZiB5b3UgZXhwZXJpZW5jZSBhbnkgb2YgdGhlIGZvbGxvd2luZzoKCiAgPHVsIHN0eWxlPSJtYXJnaW4tdG9wOiAxZW07IG1hcmdpbi1ib3R0b206IDFlbTsiPgogICAgPGxpPjxzdHJvbmc+U2V2ZXJlIGRpenppbmVzcyBvciBmYWludGluZzwvc3Ryb25nPiDigJMgbWF5IGluZGljYXRlIGxvdyBibG9vZCBwcmVzc3VyZSBvciBmbHVpZCBsb3NzPC9saT4KICAgIDxsaT48c3Ryb25nPk11c2NsZSBjcmFtcHMgb3Igd2Vha25lc3M8L3N0cm9uZz4g4oCTIGNvdWxkIGJlIGEgc2lnbiBvZiBsb3cgcG90YXNzaXVtPC9saT4KICAgIDxsaT48c3Ryb25nPklycmVndWxhciBvciBmYXN0IGhlYXJ0YmVhdDwvc3Ryb25nPiDigJMgbWF5IGluZGljYXRlIGEgc2VyaW91cyBlbGVjdHJvbHl0ZSBpbWJhbGFuY2U8L2xpPgogICAgPGxpPjxzdHJvbmc+U3VkZGVuIGNoZXN0IHBhaW48L3N0cm9uZz4g4oCTIHBvc3NpYmxlIGNhcmRpYWMgY29tcGxpY2F0aW9uPC9saT4KICAgIDxsaT48c3Ryb25nPkNvbmZ1c2lvbiBvciBleHRyZW1lIGZhdGlndWU8L3N0cm9uZz4g4oCTIG1heSBzaWduYWwgbG93IHNvZGl1bSBvciBkZWh5ZHJhdGlvbjwvbGk+CiAgICA8bGk+PHN0cm9uZz5IZWFyaW5nIGxvc3Mgb3IgcmluZ2luZyBpbiB0aGUgZWFyczwvc3Ryb25nPiDigJMgcmFyZSBidXQgc2VyaW91cyBhdCBoaWdoIGRvc2VzPC9saT4KICAgIDxsaT48c3Ryb25nPlRyb3VibGUgYnJlYXRoaW5nIG9yIHN3ZWxsaW5nIG9mIHRoZSBmYWNlL2xpcHM8L3N0cm9uZz4g4oCTIHBvc3NpYmxlIGFsbGVyZ2ljIHJlYWN0aW9uPC9saT4KICA8L3VsPgoKICA8YnV0dG9uIG9uY2xpY2s9ImNhbGxFbWVyZ2VuY3lTdXBwb3J0KCkiIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiNkOTUzNGY7Y29sb3I6d2hpdGU7cGFkZGluZzowLjc1ZW0gMS41ZW07Ym9yZGVyOm5vbmU7Ym9yZGVyLXJhZGl1czo1cHg7Zm9udC13ZWlnaHQ6Ym9sZDtjdXJzb3I6cG9pbnRlcjsiPgogICAg8J+aqCBDb250YWN0IEVtZXJnZW5jeSBTdXBwb3J0CiAgPC9idXR0b24+CjwvZGl2PgogICAgICBgOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhbm5lckRpdi5pbm5lckhUTUwgPSBgCjxkaXYgY2xhc3M9ImFsZXJ0LWJhbm5lciBlbWVyZ2VuY3ktY2FsbCBwcmVhZG1pc3Npb24tbGVucyIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6I2ZmZjNjZDtwYWRkaW5nOjFlbTtib3JkZXI6MXB4IHNvbGlkICNmNWMyYzc7bWFyZ2luLWJvdHRvbToxZW07Ym9yZGVyLXJhZGl1czo1cHg7Zm9udC1mYW1pbHk6c2Fucy1zZXJpZjsiPgogIDxzdHJvbmc+4pqg77iPIFdhcm5pbmcgZm9yIHBhdGllbnRzIHdpdGggaGVhcnQgZmFpbHVyZSB0YWtpbmcgRnVyb3NlbWlkZTwvc3Ryb25nPjxicj48YnI+CgogIEZ1cm9zZW1pZGUgaGVscHMgcmVkdWNlIGZsdWlkIGJ1aWxkdXAsIGJ1dCBpbiBzb21lIGNhc2VzIGl0IG1heSBjYXVzZSBzZXJpb3VzIHNpZGUgZWZmZWN0cyB0aGF0IHJlcXVpcmUgaW1tZWRpYXRlIG1lZGljYWwgYXR0ZW50aW9uLiBQbGVhc2Ugc3RvcCBhbmQgc2VlayBlbWVyZ2VuY3kgY2FyZSBpZiB5b3UgZXhwZXJpZW5jZSBhbnkgb2YgdGhlIGZvbGxvd2luZzoKCiAgPHVsIHN0eWxlPSJtYXJnaW4tdG9wOiAxZW07IG1hcmdpbi1ib3R0b206IDFlbTsiPgogICAgPGxpPjxzdHJvbmc+U2V2ZXJlIGRpenppbmVzcyBvciBmYWludGluZzwvc3Ryb25nPiDigJMgbWF5IGluZGljYXRlIGxvdyBibG9vZCBwcmVzc3VyZSBvciBmbHVpZCBsb3NzPC9saT4KICAgIDxsaT48c3Ryb25nPk11c2NsZSBjcmFtcHMgb3Igd2Vha25lc3M8L3N0cm9uZz4g4oCTIGNvdWxkIGJlIGEgc2lnbiBvZiBsb3cgcG90YXNzaXVtPC9saT4KICAgIDxsaT48c3Ryb25nPklycmVndWxhciBvciBmYXN0IGhlYXJ0YmVhdDwvc3Ryb25nPiDigJMgbWF5IGluZGljYXRlIGEgc2VyaW91cyBlbGVjdHJvbHl0ZSBpbWJhbGFuY2U8L2xpPgogICAgPGxpPjxzdHJvbmc+U3VkZGVuIGNoZXN0IHBhaW48L3N0cm9uZz4g4oCTIHBvc3NpYmxlIGNhcmRpYWMgY29tcGxpY2F0aW9uPC9saT4KICAgIDxsaT48c3Ryb25nPkNvbmZ1c2lvbiBvciBleHRyZW1lIGZhdGlndWU8L3N0cm9uZz4g4oCTIG1heSBzaWduYWwgbG93IHNvZGl1bSBvciBkZWh5ZHJhdGlvbjwvbGk+CiAgICA8bGk+PHN0cm9uZz5IZWFyaW5nIGxvc3Mgb3IgcmluZ2luZyBpbiB0aGUgZWFyczwvc3Ryb25nPiDigJMgcmFyZSBidXQgc2VyaW91cyBhdCBoaWdoIGRvc2VzPC9saT4KICAgIDxsaT48c3Ryb25nPlRyb3VibGUgYnJlYXRoaW5nIG9yIHN3ZWxsaW5nIG9mIHRoZSBmYWNlL2xpcHM8L3N0cm9uZz4g4oCTIHBvc3NpYmxlIGFsbGVyZ2ljIHJlYWN0aW9uPC9saT4KICA8L3VsPgoKICA8YnV0dG9uIG9uY2xpY2s9ImNhbGxFbWVyZ2VuY3lTdXBwb3J0KCkiIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiNkOTUzNGY7Y29sb3I6d2hpdGU7cGFkZGluZzowLjc1ZW0gMS41ZW07Ym9yZGVyOm5vbmU7Ym9yZGVyLXJhZGl1czo1cHg7Zm9udC13ZWlnaHQ6Ym9sZDtjdXJzb3I6cG9pbnRlcjsiPgogICAg8J+aqCBDb250YWN0IEVtZXJnZW5jeSBTdXBwb3J0CiAgPC9idXR0b24+CjwvZGl2PgogICAgICBgOwoKICAgICAgICB9CgogICAgICAgIGNvbnN0IGJvZHkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJib2R5Iik7CiAgICAgICAgaWYgKGJvZHkpIHsKICAgICAgICAgICAgYm9keS5pbnNlcnRCZWZvcmUoYmFubmVyRGl2LCBib2R5LmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyDinIUgQWRkIHRoZSBlbWVyZ2VuY3kgc2NyaXB0IG9uY2UsIG9ubHkgaWYgbm90IGFscmVhZHkgcHJlc2VudAogICAgaWYgKCFkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY2FsbC1lbWVyZ2VuY3ktc2NyaXB0IikpIHsKICAgICAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICBzY3JpcHQuaWQgPSAiY2FsbC1lbWVyZ2VuY3ktc2NyaXB0IjsKICAgICAgICBzY3JpcHQudHlwZSA9ICJ0ZXh0L2phdmFzY3JpcHQiOwogICAgICAgIHNjcmlwdC50ZXh0Q29udGVudCA9IGAKICAgICAgZnVuY3Rpb24gY2FsbEVtZXJnZW5jeVN1cHBvcnQoKSB7CiAgICAgICAgZmV0Y2goImh0dHBzOi8veW91ci1hcGkuZXhhbXBsZS5jb20vZW1lcmdlbmN5IiwgewogICAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIKICAgICAgICAgIH0sCiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIHBhdGllbnRJZDogIjEyMzQ1NiIsCiAgICAgICAgICAgIGRydWc6ICJGdXJvc2VtaWRlIiwKICAgICAgICAgICAgY29uZGl0aW9uOiAiSGVhcnQgRmFpbHVyZSIsCiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgICAgICAgICByZWFzb246ICJFbWVyZ2VuY3kgcmVhY3Rpb24gcmVwb3J0ZWQgdmlhIGVQSSBhbGVydCIKICAgICAgICAgIH0pCiAgICAgICAgfSkKICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICBpZiAocmVzcG9uc2Uub2spIHsKICAgICAgICAgICAgYWxlcnQoIkVtZXJnZW5jeSBzdXBwb3J0IGhhcyBiZWVuIG5vdGlmaWVkLiIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYWxlcnQoIkNvdWxkIG5vdCBjb250YWN0IHN1cHBvcnQuIFBsZWFzZSBjYWxsIGVtZXJnZW5jeSBzZXJ2aWNlcyBkaXJlY3RseS4iKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoKSA9PiB7CiAgICAgICAgICBhbGVydCgiTmV0d29yayBlcnJvci4gUGxlYXNlIGNhbGwgZW1lcmdlbmN5IHNlcnZpY2VzIGRpcmVjdGx5LiIpOwogICAgICAgIH0pOwogICAgICB9CiAgICBgOwogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgIH0KCgogICAgLy8gQ2xlYW4gaGVhZCAoc2FtZSBhcyB5b3VyIG9yaWdpbmFsIGxvZ2ljKQogICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIikubGVuZ3RoID4gMCkgewogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0ucmVtb3ZlKCk7CiAgICB9CgogICAgLy8gRXh0cmFjdCBIVE1MIHJlc3VsdAogICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IikubGVuZ3RoID4gMCkgewogICAgICAgIHJlc3BvbnNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXS5pbm5lckhUTUw7CiAgICAgICAgY29uc29sZS5sb2coIlJlc3BvbnNlOiAiICsgcmVzcG9uc2UpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZygiUmVzcG9uc2U6ICIgKyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MKTsKICAgICAgICByZXNwb25zZSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUw7CiAgICB9CgogICAgaWYgKCFyZXNwb25zZSB8fCByZXNwb25zZS50cmltKCkgPT09ICIiKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbm5vdGF0aW9uIHByb2Nlc3MgZmFpbGVkOiBlbXB0eSBvciBudWxsIHJlc3BvbnNlIik7CiAgICB9CgogICAgcmV0dXJuIHJlc3BvbnNlOwp9OwoKbGV0IGVuaGFuY2UgPSBhc3luYyAoKSA9PiB7CgogICAgaWYgKCFlcGlEYXRhIHx8ICFlcGlEYXRhLmVudHJ5IHx8IGVwaURhdGEuZW50cnkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJlUEkgaXMgZW1wdHkgb3IgaW52YWxpZC4iKTsKICAgIH0KICAgIGxldCBsaXN0T2ZDYXRlZ29yaWVzVG9TZWFyY2ggPSBbeyAiY29kZSI6ICJncmF2LTUiLCAic3lzdGVtIjogImh0dHBzOi8vd3d3LmdyYXZpdGF0ZWhlYWx0aC5ldS9zaWQvZG9jIiB9XTsgLy93aGF0IHRvIGxvb2sgaW4gZXh0ZW5zaW9ucyAtbWFkZSB1cCBjb2RlIGJlY2F1c2UgdGhlcmUgaXMgbm9uZQoKICAgIC8vIE1hdGNoIGxpc3RzCiAgICBjb25zdCBCVU5ETEVfSURFTlRJRklFUl9MSVNUID0gWyJlcGlidW5kbGUtMTIzIiwgImVwaWJ1bmRsZS1hYmMiXTsKICAgIGNvbnN0IFBST0RVQ1RfSURFTlRJRklFUl9MSVNUID0gWyJDSVQtMjA0NDQ3IiwgIlJJUy0xOTczNjEiXTsKCgogICAgbGV0IG1hdGNoRm91bmQgPSBmYWxzZTsKICAgIGxldCBsYW5ndWFnZURldGVjdGVkID0gbnVsbDsKCiAgICAvLyAxLiBDaGVjayBDb21wb3NpdGlvbi5sYW5ndWFnZQogICAgZXBpRGF0YS5lbnRyeT8uZm9yRWFjaCgoZW50cnkpID0+IHsKICAgICAgICBjb25zdCByZXMgPSBlbnRyeS5yZXNvdXJjZTsKICAgICAgICBpZiAocmVzPy5yZXNvdXJjZVR5cGUgPT09ICJDb21wb3NpdGlvbiIgJiYgcmVzLmxhbmd1YWdlKSB7CiAgICAgICAgICAgIGxhbmd1YWdlRGV0ZWN0ZWQgPSByZXMubGFuZ3VhZ2U7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCLwn4yNIERldGVjdGVkIGZyb20gQ29tcG9zaXRpb24ubGFuZ3VhZ2U6IiwgbGFuZ3VhZ2VEZXRlY3RlZCk7CiAgICAgICAgfQogICAgfSk7CgogICAgLy8gMi4gSWYgbm90IGZvdW5kLCBjaGVjayBCdW5kbGUubGFuZ3VhZ2UKICAgIGlmICghbGFuZ3VhZ2VEZXRlY3RlZCAmJiBlcGlEYXRhLmxhbmd1YWdlKSB7CiAgICAgICAgbGFuZ3VhZ2VEZXRlY3RlZCA9IGVwaURhdGEubGFuZ3VhZ2U7CiAgICAgICAgY29uc29sZS5sb2coIvCfjI0gRGV0ZWN0ZWQgZnJvbSBCdW5kbGUubGFuZ3VhZ2U6IiwgbGFuZ3VhZ2VEZXRlY3RlZCk7CiAgICB9CgogICAgLy8gMy4gRmFsbGJhY2sgbWVzc2FnZQogICAgaWYgKCFsYW5ndWFnZURldGVjdGVkKSB7CiAgICAgICAgY29uc29sZS53YXJuKCLimqDvuI8gTm8gbGFuZ3VhZ2UgZGV0ZWN0ZWQgaW4gQ29tcG9zaXRpb24gb3IgQnVuZGxlLiIpOwogICAgfQoKICAgIC8vIENoZWNrIGJ1bmRsZS5pZGVudGlmaWVyLnZhbHVlCiAgICBpZiAoCiAgICAgICAgZXBpRGF0YS5pZGVudGlmaWVyICYmCiAgICAgICAgQlVORExFX0lERU5USUZJRVJfTElTVC5pbmNsdWRlcyhlcGlEYXRhLmlkZW50aWZpZXIudmFsdWUpCiAgICApIHsKICAgICAgICBjb25zb2xlLmxvZygi8J+UlyBNYXRjaGVkIGVQSSBCdW5kbGUuaWRlbnRpZmllcjoiLCBlcGlEYXRhLmlkZW50aWZpZXIudmFsdWUpOwogICAgICAgIG1hdGNoRm91bmQgPSB0cnVlOwogICAgfQoKICAgIC8vIENoZWNrIE1lZGljaW5hbFByb2R1Y3REZWZpbml0aW9uLmlkZW50aWZpZXIudmFsdWUKICAgIGVwaURhdGEuZW50cnkuZm9yRWFjaCgoZW50cnkpID0+IHsKICAgICAgICBjb25zdCByZXMgPSBlbnRyeS5yZXNvdXJjZTsKICAgICAgICBpZiAocmVzPy5yZXNvdXJjZVR5cGUgPT09ICJNZWRpY2luYWxQcm9kdWN0RGVmaW5pdGlvbiIpIHsKICAgICAgICAgICAgY29uc3QgaWRzID0gcmVzLmlkZW50aWZpZXIgfHwgW107CiAgICAgICAgICAgIGlkcy5mb3JFYWNoKChpZCkgPT4gewogICAgICAgICAgICAgICAgaWYgKFBST0RVQ1RfSURFTlRJRklFUl9MSVNULmluY2x1ZGVzKGlkLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCLwn5KKIE1hdGNoZWQgTWVkaWNpbmFsUHJvZHVjdERlZmluaXRpb24uaWRlbnRpZmllcjoiLCBpZC52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2hGb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8vIGVQSSB0cmFzbGF0aW9uIGZyb20gdGVybWlub2xvZ3kgY29kZXMgdG8gdGhlaXIgaHVtYW4gcmVkYWJsZSB0cmFuc2xhdGlvbnMgaW4gdGhlIHNlY3Rpb25zCiAgICAvLyBpbiB0aGlzIGNhc2UsIGlmIGlzIGRvZXMgbm90IGZpbmQgYSBwbGFjZSwgYWRkcyBpdCB0byB0aGUgdG9wIG9mIHRoZSBlUEkKICAgIGxldCBjb21wb3NpdGlvbnMgPSAwOwogICAgbGV0IGNhdGVnb3JpZXMgPSBbXTsKICAgIGVwaS5lbnRyeS5mb3JFYWNoKChlbnRyeSkgPT4gewogICAgICAgIGlmIChlbnRyeS5yZXNvdXJjZS5yZXNvdXJjZVR5cGUgPT0gIkNvbXBvc2l0aW9uIikgewogICAgICAgICAgICBjb21wb3NpdGlvbnMrKzsKICAgICAgICAgICAgLy9JdGVyYXRlZCB0aHJvdWdoIHRoZSBDb25kaXRpb24gZWxlbWVudCBzZWFyY2hpbmcgZm9yIGNvbmRpdGlvbnMKICAgICAgICAgICAgZW50cnkucmVzb3VyY2UuZXh0ZW5zaW9uLmZvckVhY2goKGVsZW1lbnQpID0+IHsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcG9zaXRpb24gb2YgdGhlIGV4dGVuc2lvblsxXSBpcyBjb3JyZWN0CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5leHRlbnNpb25bMV0udXJsID09ICJjb25jZXB0IikgewogICAgICAgICAgICAgICAgICAgIC8vIFNlYXJjaCB0aHJvdWdoIHRoZSBkaWZmZXJlbnQgdGVybWlub2xvZ2llcyB0aGF0IG1heSBiZSBhdmFpYmxlIHRvIGNoZWNrIGluIHRoZSBjb25kaXRpb24KICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5leHRlbnNpb25bMV0udmFsdWVDb2RlYWJsZVJlZmVyZW5jZS5jb25jZXB0ICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmV4dGVuc2lvblsxXS52YWx1ZUNvZGVhYmxlUmVmZXJlbmNlLmNvbmNlcHQuY29kaW5nLmZvckVhY2goCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoY29kaW5nKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkV4dGVuc2lvbjogIiArIGVsZW1lbnQuZXh0ZW5zaW9uWzBdLnZhbHVlU3RyaW5nICsgIjoiICsgY29kaW5nLmNvZGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGNvZGUgaXMgaW4gdGhlIGxpc3Qgb2YgY2F0ZWdvcmllcyB0byBzZWFyY2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlzdE9mQ2F0ZWdvcmllc1RvU2VhcmNoLnNvbWUoaXRlbSA9PiBpdGVtLmNvZGUgPT09IGNvZGluZy5jb2RlICYmIGl0ZW0uc3lzdGVtID09PSBjb2Rpbmcuc3lzdGVtKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiRm91bmQiLCBlbGVtZW50LmV4dGVuc2lvblswXS52YWx1ZVN0cmluZykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGNhdGVnb3J5IGlzIGFscmVhZHkgaW4gdGhlIGxpc3Qgb2YgY2F0ZWdvcmllcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXRlZ29yaWVzLnB1c2goZWxlbWVudC5leHRlbnNpb25bMF0udmFsdWVTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pOwogICAgaWYgKGNvbXBvc2l0aW9ucyA9PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWQgZVBJOiBubyBjYXRlZ29yeSAiQ29tcG9zaXRpb24iIGZvdW5kJyk7CiAgICB9CgogICAgaWYgKCFtYXRjaEZvdW5kKSB7CiAgICAgICAgY29uc29sZS5sb2coImVQSSBpcyBub3QgZm9yIGEgaGlnaC1yaXNrIHNpZGUgZWZmZWN0IG1lZGljYXRpb24iKTsKICAgICAgICByZXR1cm4gaHRtbERhdGE7CiAgICB9CgogICAgZWxzZSB7CgoKICAgICAgICBsZXQgcmVzcG9uc2UgPSBodG1sRGF0YTsKICAgICAgICBsZXQgZG9jdW1lbnQ7CgogICAgICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICBsZXQganNkb20gPSBhd2FpdCBpbXBvcnQoImpzZG9tIik7CiAgICAgICAgICAgIGxldCB7IEpTRE9NIH0gPSBqc2RvbTsKICAgICAgICAgICAgbGV0IGRvbSA9IG5ldyBKU0RPTShodG1sRGF0YSk7CiAgICAgICAgICAgIGRvY3VtZW50ID0gZG9tLndpbmRvdy5kb2N1bWVudDsKICAgICAgICAgICAgcmV0dXJuIGluc2VydFF1ZXN0aW9ubmFpcmVMaW5rKGNhdGVnb3JpZXMsIGxhbmd1YWdlRGV0ZWN0ZWQsIGRvY3VtZW50LCByZXNwb25zZSk7CiAgICAgICAgICAgIC8vbGlzdE9mQ2F0ZWdvcmllcywgZW5oYW5jZVRhZywgZG9jdW1lbnQsIHJlc3BvbnNlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBpbnNlcnRRdWVzdGlvbm5haXJlTGluayhjYXRlZ29yaWVzLCBsYW5ndWFnZURldGVjdGVkLCBkb2N1bWVudCwgcmVzcG9uc2UpOwogICAgICAgIH0KICAgIH07Cn07CgpyZXR1cm4gewogICAgZW5oYW5jZTogZW5oYW5jZSwKICAgIGdldFNwZWNpZmljYXRpb246IGdldFNwZWNpZmljYXRpb24sCn07Cg=="
}